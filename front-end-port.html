<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aura</title>
    <!-- Importing Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@700&display=swap"
      rel="stylesheet"
    />

    <!-- Chart.js library for the dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* --- THEME COLORS & DARK MODE --- */
      :root {
        --background-color: #f8fafc;
        --surface-color: #ffffff;
        --border-color: #e2e8f0;
        --primary-text-color: #1e29b;
        --secondary-text-color: #64748b;
        --accent-color: #7c3aed;
        --accent-light-color: #f5f3ff;
        --chart-grid-color: #e5e7eb;
      }

      body[data-theme="dark"] {
        --background-color: #111827;
        --surface-color: #1f2937;
        --border-color: #374151;
        --primary-text-color: #f9fafb;
        --secondary-text-color: #9ca3af;
        --accent-light-color: #3730a3;
        --chart-grid-color: #4b5563;
      }

      /* --- UNIFIED BACKGROUND & HOVER UPGRADES --- */
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        color: var(--primary-text-color);
        background: var(--background-color);
        transition: background-color 0.3s ease, color 0.3s ease;
        overflow-x: hidden;
      }
      header#mainHeader {
        position: relative;
        z-index: 50;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        max-width: 1280px;
        margin: 0 auto;
      }
      .logo {
        font-weight: 700;
        font-size: 1.75rem;
        cursor: pointer;
        transition: transform 0.2s ease-in-out;
      }
      .logo:hover {
        transform: scale(1.05);
      }
      nav {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 9999px;
        padding: 0.25rem 0.5rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      body[data-theme="dark"] nav {
        background: rgba(31, 41, 55, 0.75);
        border-color: rgba(55, 65, 81, 0.5);
      }
      nav a {
        margin: 0 0.25rem;
        padding: 0.5rem 1rem;
        text-decoration: none;
        color: #334155;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        border-radius: 9999px;
      }
      body[data-theme="dark"] nav a {
        color: var(--secondary-text-color);
      }
      nav a:not(.animated-gradient):hover {
        color: var(--accent-color);
        background-color: rgba(237, 233, 254, 0.5);
      }
      body[data-theme="dark"] nav a:not(.animated-gradient):hover {
        background-color: var(--accent-light-color);
        color: var(--primary-text-color);
      }
      .hero-section {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 6rem 2rem 18rem;
        overflow: hidden;
        background: linear-gradient(
          to bottom,
          var(--accent-light-color),
          var(--background-color) 300px
        );
      }
      .page-background-image {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 1500px;
        max-width: none;
        z-index: 0;
        opacity: 0.6;
        filter: brightness(1);
        transition: filter 0.3s ease;
      }
      body[data-theme="dark"] .page-background-image {
        filter: brightness(0.7);
      }
      .hero-content {
        position: relative;
        z-index: 1;
      }
      .hero-content h1 {
        font-family: "Lora", serif;
        font-size: 4rem;
        margin-bottom: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.04em;
        line-height: 1.15;
      }
      .hero-content p {
        font-size: 1.25rem;
        color: #475569;
        margin: 0 auto 2.5rem;
        max-width: 600px;
        line-height: 1.6;
      }
      body[data-theme="dark"] .hero-content p {
        color: var(--secondary-text-color);
      }
      .cta-button {
        color: #fff;
        padding: 1rem 2rem;
        border-radius: 9999px;
        text-decoration: none;
        font-weight: 600;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .form-page-wrapper {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
        box-sizing: border-box;
        position: relative;
        overflow: hidden;
        background: linear-gradient(
          to bottom,
          var(--accent-light-color),
          var(--background-color) 300px
        );
      }
      .form-page-wrapper .page-background-image {
        opacity: 0.3; /* Make it more subtle on form pages */
      }
      .form-container {
        width: 100%;
        max-width: 450px;
        padding: 2.5rem;
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-sizing: border-box;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        position: relative;
        z-index: 1;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .form-container h2 {
        text-align: center;
        font-size: 1.5rem;
        margin-top: 0;
        margin-bottom: 2rem;
        color: var(--primary-text-color);
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--secondary-text-color);
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        background-color: var(--background-color);
        color: var(--primary-text-color);
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        transition: border-color 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out, background-color 0.3s ease;
      }
      .form-group input:focus,
      .form-group select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px var(--accent-light-color);
        outline: none;
      }
      .form-row {
        display: flex;
        gap: 1rem;
      }
      .form-row .form-group {
        flex: 1;
      }
      .submit-button {
        width: 100%;
        padding: 0.75rem;
        border: none;
        border-radius: 0.5rem;
        color: #fff;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .form-footer {
        text-align: center;
        margin-top: 1.5rem;
      }
      .form-footer a {
        color: var(--secondary-text-color);
        text-decoration: none;
        font-size: 0.9rem;
        cursor: pointer;
        transition: color 0.2s;
      }
      .form-footer a:hover {
        color: var(--primary-text-color);
      }
      #dashboardPage {
        background-color: transparent;
      }
      .dashboard-card {
        background-color: var(--surface-color);
        transition: transform 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out, background-color 0.3s ease;
      }
      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
      }
      body[data-theme="dark"] .dashboard-card:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3),
          0 4px 6px -4px rgb(0 0 0 / 0.3);
      }
      .dev-button {
        transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out;
      }
      .dev-button:hover {
        transform: scale(1.05);
        filter: brightness(1.1);
      }
      .chat-bubble {
        transition: transform 0.2s ease-in-out;
      }
      .chat-bubble:hover {
        transform: scale(1.02);
      }
      .alert-bubble {
        background-color: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
        font-weight: 500;
      }
      body[data-theme="dark"] .alert-bubble {
        background-color: #450a0a;
        color: #fca5a5;
        border-color: #7f1d1d;
      }
      #chart-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        z-index: 100;
        font-size: 0.85rem;
      }

      /* --- ANIMATED GRADIENT STYLES --- */
      .animated-gradient {
        background-image: linear-gradient(
          to right,
          #7c3aed 0%,
          #ff69b4 50%,
          #7c3aed 100%
        );
        background-size: 200% 200%;
        animation: gradient-move 3s ease infinite;
        color: white !important;
        border: none;
      }
      .animated-gradient:hover {
        animation-play-state: paused;
      }
      @keyframes gradient-move {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* --- THEME TOGGLE BUTTON --- */
      #themeToggle {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #themeToggle:hover {
        background-color: var(--accent-light-color);
      }
      #themeToggle svg {
        width: 24px;
        height: 24px;
        fill: var(--primary-text-color);
      }
      #moonIcon {
        display: none;
      }
      body[data-theme="dark"] #sunIcon {
        display: none;
      }
      body[data-theme="dark"] #moonIcon {
        display: block;
      }
    </style>
  </head>
  <body>
    <header id="mainHeader">
      <div class="logo" id="logo">Aura</div>
      <nav>
        <button id="themeToggle" title="Toggle theme">
          <svg id="sunIcon" viewBox="0 0 24 24">
            <path
              d="M12 9a3 3 0 100 6 3 3 0 000-6zm0 8a5 5 0 110-10 5 5 0 010 10zm0-13a1 1 0 011 1v1a1 1 0 11-2 0V5a1 1 0 011-1zm-7.07 3.93a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zm14.14 0a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM4 12a1 1 0 01-1-1H2a1 1 0 110-2h1a1 1 0 011 1zm16 0a1 1 0 01-1-1h-1a1 1 0 110-2h1a1 1 0 011 1zm-7.07 7.07a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zm-5.656 0a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707zM12 20a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1z"
            ></path>
          </svg>
          <svg id="moonIcon" viewBox="0 0 24 24">
            <path
              d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
            ></path>
          </svg>
        </button>
        <a id="logInLink" class="animated-gradient">Log In</a>
        <a id="registerLink" class="animated-gradient">Register</a>
        <a
          href="#"
          id="downloadReportBtn"
          class="animated-gradient"
          style="display: none"
          >Download Report</a
        >
        <a href="#" id="logOutButton" style="display: none">Log Out</a>
      </nav>
    </header>

    <div id="mainPage">
      <section class="hero-section">
        <div class="hero-content">
          <h1>Welcome to Aura</h1>
          <p>
            Living with diabetes is challenging. Aura helps you make informed
            decisions with AI-powered insights, predictions, and
            recommendations.
          </p>
          <a
            href="#"
            class="cta-button animated-gradient"
            id="getStartedBtn"
            >Get Started<span>&rarr;</span></a
          >
        </div>
        <img
          src="https://fly.io/phx/ui/images/cloud-city-a61199fec62cd744415fcdf4e1be8434.png?vsn=d"
          class="page-background-image"
          alt="Cloud city illustration"
        />
      </section>
    </div>

    <!-- Registration Page -->
    <div id="registerPage" class="form-page-wrapper">
      <div class="form-container">
        <h2 class="text-2xl font-semibold text-center">Create Your Account</h2>
        <form id="registerForm">
          <div class="form-group">
            <label for="register-email">Email (for login)</label>
            <input type="email" id="register-email" required />
          </div>
          <div class="form-group">
            <label for="register-password">Password</label>
            <input type="password" id="register-password" required />
          </div>
          <hr class="my-6 border-gray-200" />
          <div class="form-group">
            <label for="register-name">Full Name</label>
            <input type="text" id="register-name" required />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="register-age">Age</label>
              <input type="number" id="register-age" />
            </div>
            <div class="form-group">
              <label for="register-gender">Gender</label>
              <select id="register-gender">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="register-phone">Phone</label>
            <input type="tel" id="register-phone" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="register-weight">Weight (kg)</label>
              <input type="number" step="0.1" id="register-weight" />
            </div>
            <div class="form-group">
              <label for="register-height">Height (cm)</label>
              <input type="number" id="register-height" />
            </div>
          </div>
          <button
            type="submit"
            class="submit-button mt-4 animated-gradient"
          >
            Create Account
          </button>
        </form>
        <div class="form-footer">
          <a href="#" id="backToLoginLink"
            >&larr; Already have an account? Log in</a
          >
        </div>
      </div>
      <img
        src="https://fly.io/phx/ui/images/cloud-city-a61199fec62cd744415fcdf4e1be8434.png?vsn=d"
        class="page-background-image"
        alt="Cloud city illustration"
      />
    </div>

    <!-- Log-In Page -->
    <div id="logInPage" class="form-page-wrapper">
      <div class="form-container">
        <h2 class="text-2xl font-semibold text-center">Log In to Aura</h2>
        <form id="logInForm">
          <div class="form-group">
            <label for="email-login">Email address</label>
            <input type="email" id="email-login" name="email" required />
          </div>
          <div class="form-group">
            <label for="password-login">Password</label>
            <input
              type="password"
              id="password-login"
              name="password"
              required
            />
          </div>
          <button
            type="submit"
            class="submit-button mt-2 animated-gradient"
          >
            Continue
          </button>
        </form>
        <div class="form-footer">
          <a href="#" class="backToHomeLink">&larr; Back to Home</a>
        </div>
      </div>
      <img
        src="https://fly.io/phx/ui/images/cloud-city-a61199fec62cd744415fcdf4e1be8434.png?vsn=d"
        class="page-background-image"
        alt="Cloud city illustration"
      />
    </div>

    <!-- Dashboard Page -->
    <div
      id="dashboardPage"
      style="display: none"
      class="min-h-screen"
    >
      <div class="max-w-6xl mx-auto space-y-6 p-4 sm:p-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Dashboard</h2>
          <div class="flex items-center gap-2">
            <button
              id="calibrateAiBtn"
              class="bg-blue-400 text-blue-800 text-xs font-bold py-1 px-3 rounded-full dev-button"
            >
              Calibrate AI
            </button>
            <button
              id="devSimulateBtn"
              class="bg-yellow-400 text-yellow-800 text-xs font-bold py-1 px-3 rounded-full dev-button"
            >
              DEV: Add Demo Data
            </button>
          </div>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow relative dashboard-card">
          <canvas id="glucoseChart" height="200"></canvas>
          <div id="chart-tooltip"></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="p-4 rounded-2xl shadow dashboard-card">
            <div class="text-sm text-gray-500">Carbs Detected</div>
            <div id="carbs-value" class="text-3xl font-bold">—</div>
          </div>
          <div class="p-4 rounded-2xl shadow dashboard-card">
            <div class="text-sm text-gray-500">Insulin Suggestion</div>
            <div id="dose-value" class="text-3xl font-bold">—</div>
            <div id="dose-reason" class="text-xs text-gray-500 mt-2"></div>
          </div>
          <div class="p-4 rounded-2xl shadow dashboard-card">
            <div class="text-sm text-gray-500">Short-Term Trend</div>
            <div id="trend-value" class="text-3xl font-bold capitalize">—</div>
          </div>
        </div>
        <div class="p-4 rounded-2xl shadow dashboard-card">
          <div
            id="chat-history"
            class="space-y-3 h-72 overflow-auto mb-3 p-2 border rounded-lg"
            style="border-color: var(--border-color); transition: border-color 0.3s ease;"
          ></div>
          <div class="flex items-center gap-3">
            <input
              id="chat-input"
              type="text"
              placeholder="e.g., had a sandwich and an apple for lunch"
              class="flex-1 p-3 rounded-lg border"
            />
            <button
              id="send-btn"
              class="px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold"
            >
              Send
            </button>
          </div>
          <div id="thinking" class="mt-2 text-sm text-gray-500 hidden">
            Aura is thinking…
          </div>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL = "http://127.0.0.1:5001";
      let currentUserId = null;
      let chartState = { chart: null, historicalData: [], predictionData: [] };

      // --- ELEMENT REFERENCES ---
      const pageRefs = {
        mainPage: document.getElementById("mainPage"),
        registerPage: document.getElementById("registerPage"),
        logInPage: document.getElementById("logInPage"),
        dashboardPage: document.getElementById("dashboardPage"),
        mainHeader: document.getElementById("mainHeader"),
      };
      // Forms & Buttons
      const registerForm = document.getElementById("registerForm");
      const logInForm = document.getElementById("logInForm");
      const registerLink = document.getElementById("registerLink");
      const logInLink = document.getElementById("logInLink");
      const logOutButton = document.getElementById("logOutButton");
      const downloadReportBtn = document.getElementById("downloadReportBtn");
      const backToLoginLink = document.getElementById("backToLoginLink");
      const getStartedBtn = document.getElementById("getStartedBtn");
      const logo = document.getElementById("logo");
      const backToHomeLinks = document.querySelectorAll(".backToHomeLink");
      const devSimulateBtn = document.getElementById("devSimulateBtn");
      const calibrateAiBtn = document.getElementById("calibrateAiBtn");
      const themeToggle = document.getElementById("themeToggle");
      // Dashboard Elements
      const chatInput = document.getElementById("chat-input");
      const sendBtn = document.getElementById("send-btn");
      const chatHistory = document.getElementById("chat-history");
      const thinkingEl = document.getElementById("thinking");
      const chartTooltip = document.getElementById("chart-tooltip");

      // --- THEME LOGIC ---
      function applyTheme(theme) {
        document.body.dataset.theme = theme;
        localStorage.setItem("theme", theme);
        if (chartState.chart) {
          updateChartTheme(theme);
        }
      }

      function updateChartTheme(theme) {
        if (!chartState.chart) return;
        const isDark = theme === "dark";
        const gridColor = isDark ? "#4b5563" : "#e5e7eb";
        const textColor = isDark ? "#f9fafb" : "#1e293b";
        const historicalColor = isDark ? "#a78bfa" : "#818cf8";
        const predictedColor = isDark ? "#93c5fd" : "#3b82f6";
        const histGradient = chartState.chart.ctx.createLinearGradient(
          0,
          0,
          0,
          200
        );
        histGradient.addColorStop(
          0,
          isDark ? "rgba(129, 140, 248, 0.3)" : "rgba(129, 140, 248, 0.5)"
        );
        histGradient.addColorStop(1, "rgba(129, 140, 248, 0)");

        chartState.chart.options.scales.y.grid.color = gridColor;
        chartState.chart.options.scales.x.ticks.color = textColor;
        chartState.chart.options.scales.y.ticks.color = textColor;
        chartState.chart.options.plugins.legend.labels.color = textColor;

        chartState.chart.data.datasets[0].borderColor = historicalColor;
        chartState.chart.data.datasets[0].backgroundColor = histGradient;
        chartState.chart.data.datasets[0].pointBackgroundColor =
          historicalColor;
        chartState.chart.data.datasets[1].borderColor = predictedColor;
        chartState.chart.data.datasets[1].pointBackgroundColor =
          predictedColor;

        chartState.chart.update();
      }

      themeToggle.addEventListener("click", () => {
        const newTheme =
          document.body.dataset.theme === "dark" ? "light" : "dark";
        applyTheme(newTheme);
      });

      // --- CHART LOGIC ---
      function formatLabel(ts) {
        const d = new Date(ts);
        return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
      }

      function initChart() {
        if (chartState.chart) chartState.chart.destroy();
        const ctx = document.getElementById("glucoseChart").getContext("2d");
        chartState.chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Historical",
                data: [],
                borderWidth: 2.5,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointHoverBorderWidth: 2,
                fill: true,
              },
              {
                label: "Predicted",
                data: [],
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointHoverBorderWidth: 2,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 500, easing: "easeInOutQuad" },
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: false, grid: { drawBorder: false } },
            },
            plugins: {
              legend: { display: true, position: "top", align: "end" },
              tooltip: {
                enabled: false,
                external: (context) => {
                  const { chart, tooltip } = context;
                  let tooltipEl = chart.canvas.parentNode.querySelector("div");

                  if (tooltip.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                  }

                  const { title, body } = tooltip;
                  if (title || body) {
                    const titleLines = title || [];
                    const bodyLines = body.map((b) => b.lines);

                    let innerHtml = "<div>";

                    titleLines.forEach((line) => {
                      innerHtml += `<div class="font-bold text-xs">${line}</div>`;
                    });

                    bodyLines.forEach((line, i) => {
                      const colors = tooltip.labelColors[i];
                      const style = `background: ${colors.backgroundColor}; border-color: ${colors.borderColor}; display: inline-block; width: 10px; height: 10px; margin-right: 5px; border-radius: 50%;`;
                      innerHtml += `<div class="text-xs mt-1"><span style="${style}"></span>${line}</div>`;
                    });

                    innerHtml += "</div>";
                    tooltipEl.innerHTML = innerHtml;
                  }

                  const { offsetLeft: positionX, offsetTop: positionY } =
                    chart.canvas;
                  tooltipEl.style.opacity = 1;
                  tooltipEl.style.left = positionX + tooltip.caretX + "px";
                  tooltipEl.style.top = positionY + tooltip.caretY + "px";
                  tooltipEl.style.transform = "translate(-50%, -120%)";
                  tooltipEl.style.transition = "transform 0.1s ease";
                },
              },
            },
          },
        });

        const savedTheme = localStorage.getItem("theme") || "light";
        updateChartTheme(savedTheme);
      }

      function updateChart(historicalData, predictionData = []) {
        chartState.historicalData = historicalData;
        chartState.predictionData = predictionData;

        const histTimestamps = historicalData.map((d) =>
          formatLabel(d.timestamp)
        );
        const histValues = historicalData.map((d) => d.glucose_value);

        let predLabels = [];
        let predValuesForChart = [];

        if (predictionData.length > 0 && historicalData.length > 0) {
          const lastHistTimestamp = new Date(
            historicalData[historicalData.length - 1].timestamp
          );
          predLabels = predictionData.map((_, i) =>
            formatLabel(
              new Date(lastHistTimestamp.getTime() + (i + 1) * 5 * 60000)
            )
          );
          const lastHistValue = histValues[histValues.length - 1];
          predValuesForChart = new Array(histValues.length - 1).fill(null);
          predValuesForChart.push(lastHistValue, ...predictionData);
        }

        chartState.chart.data.labels = [...histTimestamps, ...predLabels];
        chartState.chart.data.datasets[0].data = histValues;
        chartState.chart.data.datasets[1].data = predValuesForChart;
        chartState.chart.update();
      }

      // --- UI & MESSAGE LOGIC ---
      function showThinking(on = true) {
        thinkingEl.classList.toggle("hidden", !on);
      }

      function editMessage(messageText) {
        chatInput.value = messageText;
        chatInput.focus();
      }

      function pushMessage(who, text, rawText = "", type = "normal") {
        const el = document.createElement("div");
        el.className = who === "user" ? "text-right" : "text-left";
        
        let bubbleClass = "";
        if (type === 'alert') {
            bubbleClass = 'alert-bubble';
        } else {
            bubbleClass = who === "user" ? "bg-indigo-100 text-indigo-800" : "bg-gray-100 text-gray-800";
        }

        let messageContent = `<div class="chat-bubble inline-block p-2 rounded-lg text-sm ${bubbleClass}">${text}`;

        if (who === "user") {
          messageContent += `
            <button class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs" 
                    onclick="editMessage(decodeURIComponent('${encodeURIComponent(
                      rawText || text
                    )}'))">
              Edit
            </button>`;
        }
        messageContent += `</div>`;
        el.innerHTML = messageContent;
        chatHistory.appendChild(el);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      function applyAiResponseToUI(aiResponse) {
        const {
          parsed_info,
          dose_recommendation,
          glucose_prediction,
          contextual_advice,
        } = aiResponse;

        const carbsEl = document.getElementById("carbs-value");
        const doseEl = document.getElementById("dose-value");
        const reasonEl = document.getElementById("dose-reason");
        const trendEl = document.getElementById("trend-value");

        carbsEl.innerText =
          parsed_info && typeof parsed_info.carbs !== "undefined"
            ? `${parsed_info.carbs}g`
            : "—";
        if (
          dose_recommendation &&
          typeof dose_recommendation.recommended_dose !== "undefined"
        ) {
          doseEl.innerText = `${dose_recommendation.recommended_dose}u`;
          reasonEl.innerText =
            (dose_recommendation.reasoning_components
              ? dose_recommendation.reasoning_components.final_summary
              : dose_recommendation.reasoning) || "";
        } else {
          doseEl.innerText = "—";
          reasonEl.innerText = "";
        }
        
        const trend = glucose_prediction?.analysis?.trend || "N/A";
        trendEl.innerText = trend;

        if (trend.toLowerCase() === 'rising') {
            pushMessage('aura', "⚠️ **Heads up!** Your glucose trend is rising. You may need to monitor it closely.", "", "alert");
        } else if (trend.toLowerCase() === 'falling') {
            pushMessage('aura', "⚠️ **Heads up!** Your glucose trend is falling. Be mindful of potential lows.", "", "alert");
        }

        let botReply = "I've logged your entry. ";
        if (parsed_info?.carbs > 0) {
          botReply = `Got it. Logged a meal of ${parsed_info.carbs}g. `;
        }
        if (dose_recommendation?.recommended_dose > 0) {
          botReply += `Based on this, my suggested dose is <b>${dose_recommendation.recommended_dose} units</b>.`;
        } else {
          botReply += "No insulin dose seems necessary right now.";
        }
        if (contextual_advice?.exercise_reduction) {
          botReply += `<br><br><b>Heads up:</b> Consider reducing that dose by about <b>${contextual_advice.exercise_reduction_percent}%</b> due to exercise.`;
        }
        pushMessage("aura", botReply);
      }

      // --- API CALLS ---
      async function callApi(endpoint, options = {}) {
        try {
          const response = await fetch(`${BASE_URL}${endpoint}`, options);
          if (!response.ok) {
            const error = await response
              .json()
              .catch(() => ({ message: response.statusText }));
            throw new Error(error.message || error.error || "Request failed");
          }
          if (
            response.headers.get("Content-Type")?.includes("application/pdf")
          ) {
            return response.blob();
          }
          return response.json();
        } catch (error) {
          console.error(`API call to ${endpoint} failed:`, error);
          alert(`Error: ${error.message}. Could not connect to the server.`);
          throw error;
        }
      }

      async function loadDashboardData() {
        if (!currentUserId) return;
        try {
          const data = await callApi(
            `/api/dashboard?user_id=${currentUserId}`
          );
          updateChart(data.glucose_readings || []);
        } catch (error) {
          updateChart([]);
        }
      }

      // --- PAGE NAVIGATION ---
      function hideAllPages() {
        Object.values(pageRefs).forEach((el) => (el.style.display = "none"));
        pageRefs.mainHeader.style.display = "none";
      }

      function showPage(pageId, isFullScreen = false) {
        hideAllPages();
        pageRefs[pageId].style.display = isFullScreen ? "flex" : "block";
        if (!isFullScreen) pageRefs.mainHeader.style.display = "flex";
      }

      function updateNav(isLoggedIn) {
        logOutButton.style.display = isLoggedIn ? "block" : "none";
        downloadReportBtn.style.display = isLoggedIn ? "block" : "none";
        registerLink.style.display = isLoggedIn ? "none" : "block";
        logInLink.style.display = isLoggedIn ? "none" : "block";
      }

      function showMainPage() {
        showPage("mainPage");
        updateNav(false);
      }
      function showRegisterPage() {
        showPage("registerPage", true);
      }
      function showLogInPage() {
        showPage("logInPage", true);
      }

      async function showDashboardPage() {
        if (!currentUserId) {
          showLogInPage();
          return;
        }
        showPage("dashboardPage");
        updateNav(true);
        chatHistory.innerHTML = "";
        pushMessage("aura", "Welcome! How can I help?");
        await loadDashboardData();
      }

      // --- EVENT LISTENERS ---
      logo.addEventListener("click", (e) => {
        e.preventDefault();
        showMainPage();
      });
      registerLink.addEventListener("click", (e) => {
        e.preventDefault();
        showRegisterPage();
      });
      logInLink.addEventListener("click", (e) => {
        e.preventDefault();
        showLogInPage();
      });
      backToLoginLink.addEventListener("click", (e) => {
        e.preventDefault();
        showLogInPage();
      });
      getStartedBtn.addEventListener("click", (e) => {
        e.preventDefault();
        showRegisterPage();
      });
      logOutButton.addEventListener("click", (e) => {
        e.preventDefault();
        currentUserId = null;
        showMainPage();
      });
      backToHomeLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          showMainPage();
        });
      });

      downloadReportBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!currentUserId)
          return alert("Please log in to download a report.");

        const originalText = downloadReportBtn.innerHTML;
        downloadReportBtn.innerHTML = "Downloading...";
        downloadReportBtn.style.pointerEvents = "none";

        try {
          const blob = await callApi(
            `/api/user/report?user_id=${currentUserId}`
          );

          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;

          const date = new Date().toISOString().slice(0, 10);
          a.download = `Aura-Report-User-${currentUserId}-${date}.pdf`;

          document.body.appendChild(a);
          a.click();

          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error("Failed to download report:", error);
        } finally {
          downloadReportBtn.innerHTML = originalText;
          downloadReportBtn.style.pointerEvents = "auto";
        }
      });

      calibrateAiBtn.addEventListener("click", async () => {
        if (!currentUserId) return alert("Log in first.");
        if (
          !confirm(
            "This will start personalizing the AI model based on your historical data. This process runs in the background and may take a few minutes. Continue?"
          )
        ) {
          return;
        }
        try {
          const response = await callApi("/api/ai/calibrate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: currentUserId }),
          });
          alert(
            response.message ||
              "AI calibration has started successfully in the background."
          );
        } catch (error) {}
      });

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userData = {
          username: document.getElementById("register-email").value,
          password: document.getElementById("register-password").value,
          name: document.getElementById("register-name").value,
          age: parseInt(document.getElementById("register-age").value) || null,
          gender: document.getElementById("register-gender").value || null,
          phone_number:
            document.getElementById("register-phone").value || null,
          weight_kg:
            parseFloat(document.getElementById("register-weight").value) ||
            null,
          height_cm:
            parseFloat(document.getElementById("register-height").value) ||
            null,
        };
        try {
          await callApi("/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData),
          });
          alert("Registration successful! Please log in.");
          showLogInPage();
        } catch (error) {}
      });

      logInForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const loginData = {
          username: document.getElementById("email-login").value,
          password: document.getElementById("password-login").value,
        };
        try {
          const data = await callApi("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(loginData),
          });
          currentUserId = data.user_id;
          await showDashboardPage();
        } catch (error) {}
      });

      sendBtn.addEventListener("click", async () => {
        const text = chatInput.value.trim();
        if (!text || !currentUserId) return;
        pushMessage("user", text, text);
        chatInput.value = "";
        showThinking(true);
        try {
          const aiResponse = await callApi("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, user_id: currentUserId }),
          });
          applyAiResponseToUI(aiResponse);
          const historicalData = await callApi(
            `/api/dashboard?user_id=${currentUserId}`
          );
          updateChart(
            historicalData.glucose_readings || [],
            aiResponse.glucose_prediction.adjusted_prediction || []
          );
        } catch (error) {
          pushMessage(
            "aura",
            "Sorry, I couldn't get a response. Please check the connection."
          );
        } finally {
          showThinking(false);
        }
      });
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendBtn.click();
      });

      devSimulateBtn.addEventListener("click", async () => {
        if (!currentUserId) return alert("Log in first.");
        try {
          await callApi("/api/dev/simulate-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: currentUserId }),
          });
          alert(
            "New demo data has been added! The dashboard will now refresh."
          );
          await loadDashboardData();
        } catch (error) {}
      });

      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);

        initChart();
        showMainPage();
      });
    </script>
  </body>
</html>