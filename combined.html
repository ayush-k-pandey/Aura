<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aura</title>
    <!-- Importing Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@700&display=swap"
      rel="stylesheet"
    />

    <!-- Chart.js library for the dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --background-color: #f8fafc;
        --surface-color: #ffffff;
        --border-color: #e2e8f0;
        --primary-text-color: #1e293b;
        --secondary-text-color: #64748b;
        --accent-color: #7c3aed;
        --accent-light-color: #f5f3ff;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        color: var(--primary-text-color);
        background-color: var(--background-color);
        overflow-x: hidden;
      }
      header#mainHeader {
        position: relative;
        z-index: 50;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        max-width: 1280px;
        margin: 0 auto;
      }
      .logo {
        font-weight: 700;
        font-size: 1.75rem;
        cursor: pointer;
      }
      nav {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 9999px;
        padding: 0.25rem 0.5rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      nav a {
        margin: 0 0.25rem;
        padding: 0.5rem 1rem;
        text-decoration: none;
        color: #334155;
        cursor: pointer;
        font-weight: 500;
        transition: color 0.2s;
        border-radius: 9999px;
      }
      nav a:hover {
        color: var(--accent-color);
        background-color: rgba(237, 233, 254, 0.5);
      }
      .hero-section {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 6rem 2rem 18rem;
        overflow: hidden;
        background: linear-gradient(to bottom, #f3f4f6, white);
      }
      .hero-background {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 1500px;
        max-width: none;
        z-index: 0;
      }
      .hero-content {
        position: relative;
        z-index: 1;
      }
      .hero-content h1 {
        font-family: "Lora", serif;
        font-size: 4rem;
        margin-bottom: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.04em;
        line-height: 1.15;
      }
      .hero-content p {
        font-size: 1.25rem;
        color: #475569;
        margin: 0 auto 2.5rem;
        max-width: 600px;
        line-height: 1.6;
      }
      .cta-button {
        background-color: var(--accent-color);
        color: #fff;
        padding: 1rem 2rem;
        border-radius: 9999px;
        text-decoration: none;
        font-weight: 600;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .cta-button:hover {
        background-color: #6d28d9;
      }
      .form-page-wrapper {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
        box-sizing: border-box;
        position: relative;
        overflow: hidden;
        background: linear-gradient(to bottom, #f3f4f6, white);
      }
      .form-container {
        width: 100%;
        max-width: 450px;
        padding: 2.5rem;
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-sizing: border-box;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        position: relative;
        z-index: 1;
      }
      .form-container h2 {
        text-align: center;
        font-size: 1.5rem;
        margin-top: 0;
        margin-bottom: 2rem;
        color: var(--primary-text-color);
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--secondary-text-color);
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background-color: #f9fafb;
        color: var(--primary-text-color);
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        font-size: 1rem;
      }
      .form-row {
        display: flex;
        gap: 1rem;
      }
      .form-row .form-group {
        flex: 1;
      }
      .submit-button {
        width: 100%;
        padding: 0.75rem;
        border: none;
        border-radius: 0.5rem;
        background-color: var(--accent-color);
        color: #fff;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .submit-button:hover {
        background-color: #6d28d9;
      }
      .form-footer {
        text-align: center;
        margin-top: 1.5rem;
      }
      .form-footer a {
        color: var(--secondary-text-color);
        text-decoration: none;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .form-footer a:hover {
        color: var(--primary-text-color);
      }
    </style>
  </head>
  <body>
    <header id="mainHeader">
      <div class="logo" id="logo">Aura</div>
      <nav>
        <a id="logInLink">Log In</a>
        <a id="registerLink">Register</a>
        <a href="#" id="logOutButton" style="display: none">Log Out</a>
      </nav>
    </header>

    <div id="mainPage">
      <section class="hero-section">
        <div class="hero-content">
          <h1>Welcome to Aura</h1>
          <p>
            Living with diabetes is challenging. Aura helps you make informed
            decisions with AI-powered insights, predictions, and
            recommendations.
          </p>
          <a href="#" class="cta-button" id="getStartedBtn"
            >Get Started<span>&rarr;</span></a
          >
        </div>
        <img
          src="https://fly.io/phx/ui/images/cloud-city-a61199fec62cd744415fcdf4e1be8434.png?vsn=d"
          class="hero-background"
          alt="Cloud city illustration"
        />
      </section>
    </div>

    <!-- Registration Page -->
    <div id="registerPage" class="form-page-wrapper">
      <div class="form-container">
        <h2 class="text-2xl font-semibold text-center">Create Your Account</h2>
        <form id="registerForm">
          <div class="form-group">
            <label for="register-email">Email (for login)</label>
            <input type="email" id="register-email" required />
          </div>
          <div class="form-group">
            <label for="register-password">Password</label>
            <input type="password" id="register-password" required />
          </div>
          <hr class="my-6 border-gray-200" />
          <div class="form-group">
            <label for="register-name">Full Name</label>
            <input type="text" id="register-name" required />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="register-age">Age</label>
              <input type="number" id="register-age" />
            </div>
            <div class="form-group">
              <label for="register-gender">Gender</label>
              <select id="register-gender">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="register-phone">Phone</label>
            <input type="tel" id="register-phone" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="register-weight">Weight (kg)</label>
              <input type="number" step="0.1" id="register-weight" />
            </div>
            <div class="form-group">
              <label for="register-height">Height (cm)</label>
              <input type="number" id="register-height" />
            </div>
          </div>
          <button type="submit" class="submit-button mt-4">
            Create Account
          </button>
        </form>
        <div class="form-footer">
          <a href="#" id="backToLoginLink"
            >&larr; Already have an account? Log in</a
          >
        </div>
      </div>
    </div>

    <!-- Log-In Page -->
    <div id="logInPage" class="form-page-wrapper">
      <div class="form-container">
        <h2 class="text-2xl font-semibold text-center">Log In to Aura</h2>
        <form id="logInForm">
          <div class="form-group">
            <label for="email-login">Email address</label>
            <input type="email" id="email-login" name="email" required />
          </div>
          <div class="form-group">
            <label for="password-login">Password</label>
            <input
              type="password"
              id="password-login"
              name="password"
              required
            />
          </div>
          <button type="submit" class="submit-button mt-2">Continue</button>
        </form>
        <div class="form-footer">
          <a href="#" class="backToHomeLink">&larr; Back to Home</a>
        </div>
      </div>
    </div>

    <!-- Dashboard Page -->
    <div
      id="dashboardPage"
      style="display: none"
      class="bg-gray-50 min-h-screen"
    >
      <div class="max-w-6xl mx-auto space-y-6 p-4 sm:p-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Dashboard</h2>
          <button
            id="devSimulateBtn"
            class="bg-yellow-400 text-yellow-800 text-xs font-bold py-1 px-3 rounded-full hover:bg-yellow-500"
          >
            DEV: Add Demo Data
          </button>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow">
          <canvas id="glucoseChart" height="160"></canvas>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="p-4 bg-white rounded-2xl shadow">
            <div class="text-sm text-gray-500">Carbs Detected</div>
            <div id="carbs-value" class="text-3xl font-bold">—</div>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow">
            <div class="text-sm text-gray-500">Insulin Suggestion</div>
            <div id="dose-value" class="text-3xl font-bold">—</div>
            <div id="dose-reason" class="text-xs text-gray-500 mt-2"></div>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow">
            <div class="text-sm text-gray-500">Short-Term Trend</div>
            <div id="trend-value" class="text-3xl font-bold capitalize">—</div>
          </div>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow">
          <div
            id="chat-history"
            class="space-y-3 h-48 overflow-auto mb-3 p-2 border rounded-lg"
          ></div>
          <div class="flex items-center gap-3">
            <input
              id="chat-input"
              type="text"
              placeholder="e.g., had a sandwich and an apple for lunch"
              class="flex-1 p-3 rounded-lg border"
            />
            <button
              id="send-btn"
              class="px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold"
            >
              Send
            </button>
          </div>
          <div id="thinking" class="mt-2 text-sm text-gray-500 hidden">
            Aura is thinking…
          </div>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL = "http://127.0.0.1:5001";
      let currentUserId = null;
      let chartState = { chart: null };

      // --- ELEMENT REFERENCES ---
      const pageRefs = {
        mainPage: document.getElementById("mainPage"),
        registerPage: document.getElementById("registerPage"),
        logInPage: document.getElementById("logInPage"),
        dashboardPage: document.getElementById("dashboardPage"),
        mainHeader: document.getElementById("mainHeader"),
      };
      // Forms
      const registerForm = document.getElementById("registerForm");
      const logInForm = document.getElementById("logInForm");
      // Links & Buttons
      const registerLink = document.getElementById("registerLink");
      const logInLink = document.getElementById("logInLink");
      const logOutButton = document.getElementById("logOutButton");
      const backToLoginLink = document.getElementById("backToLoginLink");
      const getStartedBtn = document.getElementById("getStartedBtn");
      const logo = document.getElementById("logo");
      const backToHomeLinks = document.querySelectorAll(".backToHomeLink");
      const devSimulateBtn = document.getElementById("devSimulateBtn");
      // Dashboard Elements
      const chatInput = document.getElementById("chat-input");
      const sendBtn = document.getElementById("send-btn");
      const chatHistory = document.getElementById("chat-history");
      const thinkingEl = document.getElementById("thinking");

      // --- CHART LOGIC ---
      function formatLabel(ts) {
        const d = new Date(ts);
        return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
      }

      function initChart() {
        if (chartState.chart) chartState.chart.destroy();
        const ctx = document.getElementById("glucoseChart").getContext("2d");
        chartState.chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Historical",
                data: [],
                borderColor: "#4f46e5",
                borderWidth: 2.5,
                tension: 0.4,
                pointRadius: 2,
                fill: false,
              },
              {
                label: "Predicted",
                data: [],
                borderColor: "#a5b4fc",
                borderWidth: 2.5,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 2,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 500 },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: false, grid: { color: "#e5e7eb" } },
            },
            plugins: {
              legend: { display: true, position: "top", align: "end" },
            },
          },
        });
      }

      function updateChart(historicalData, predictionData = []) {
        const histTimestamps = historicalData.map((d) =>
          formatLabel(d.timestamp)
        );
        const histValues = historicalData.map((d) => d.glucose_value);

        let predLabels = [];
        let predValuesForChart = [];

        if (predictionData.length > 0) {
          const lastHistTimestamp = new Date(
            historicalData[historicalData.length - 1].timestamp
          );
          predLabels = predictionData.map((_, i) =>
            formatLabel(
              new Date(lastHistTimestamp.getTime() + (i + 1) * 5 * 60000)
            )
          );

          const lastHistValue = histValues[histValues.length - 1];
          predValuesForChart = new Array(histValues.length - 1).fill(null);
          predValuesForChart.push(lastHistValue, ...predictionData);
        }

        chartState.chart.data.labels = [...histTimestamps, ...predLabels];
        chartState.chart.data.datasets[0].data = histValues;
        chartState.chart.data.datasets[1].data = predValuesForChart;
        chartState.chart.update();
      }

      // --- UI & MESSAGE LOGIC ---
      function showThinking(on = true) {
        thinkingEl.classList.toggle("hidden", !on);
      }

      function pushMessage(who, text) {
        const el = document.createElement("div");
        el.className = who === "user" ? "text-right" : "text-left";
        el.innerHTML = `<div class="inline-block p-2 rounded-lg text-sm ${
          who === "user"
            ? "bg-indigo-100 text-indigo-800"
            : "bg-gray-100 text-gray-800"
        }">${text}</div>`;
        chatHistory.appendChild(el);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      // In combined.html, replace the old function with this one

// In combined.html, replace the old function with this one

function applyAiResponseToUI(aiResponse) {
    console.log("Applying AI Response to UI:", aiResponse);

    const {
      parsed_info,
      dose_recommendation,
      glucose_prediction,
      contextual_advice,
    } = aiResponse;

    // --- Update Dashboard Cards (this part is working well) ---
    const carbsEl = document.getElementById("carbs-value");
    const doseEl = document.getElementById("dose-value");
    const reasonEl = document.getElementById("dose-reason");
    const trendEl = document.getElementById("trend-value");

    if (parsed_info && typeof parsed_info.carbs !== 'undefined') {
        carbsEl.innerText = `${parsed_info.carbs}g`;
    } else { carbsEl.innerText = "—"; }

    if (dose_recommendation && typeof dose_recommendation.recommended_dose !== 'undefined') {
        doseEl.innerText = `${dose_recommendation.recommended_dose}u`;
        if (dose_recommendation.reasoning_components) {
            reasonEl.innerText = dose_recommendation.reasoning_components.final_summary;
        } else {
            reasonEl.innerText = dose_recommendation.reasoning || "";
        }
    } else {
        doseEl.innerText = "—";
        reasonEl.innerText = "";
    }
    
    if (glucose_prediction && glucose_prediction.analysis && glucose_prediction.analysis.trend) {
        trendEl.innerText = glucose_prediction.analysis.trend;
    } else {
        trendEl.innerText = "N/A";
    }

    // --- NEW AND IMPROVED CHATBOT RESPONSE LOGIC ---
    let botReply = "";

    // 1. Acknowledge the user's input
    if (parsed_info.carbs > 0 && parsed_info.activities_detected.length > 0) {
        botReply = `Okay, I've logged your meal of ${parsed_info.carbs}g and your workout. `;
    } else if (parsed_info.carbs > 0) {
        botReply = `Got it. Logged a meal of ${parsed_info.carbs}g. `;
    } else if (parsed_info.activities_detected.length > 0) {
        botReply = `Great job on the workout! I've logged it for you. `;
    } else {
        botReply = "I've logged your entry. ";
    }

    // 2. Give the most important piece of advice: the dose
    if (dose_recommendation && dose_recommendation.recommended_dose > 0) {
        botReply += `Based on this, my suggested dose is <b>${dose_recommendation.recommended_dose} units</b>.`;
    } else {
        botReply += "No insulin dose seems necessary right now.";
    }
    
    // 3. Add any extra warnings or advice from the contextual engine
    if (contextual_advice) {
        if (contextual_advice.exercise_reduction) {
            botReply += `<br><br><b>Heads up:</b> Since you're exercising, you should consider reducing that dose by about <b>${contextual_advice.exercise_reduction_percent}%</b> to avoid going low.`;
        }
        if (contextual_advice.timing_considerations && contextual_advice.timing_considerations.length > 0) {
            botReply += `<br><br><i>Note: ${contextual_advice.timing_considerations[0]}</i>`;
        }
    }

    // Push the complete, intelligent message to the chat
    pushMessage("aura", botReply);
}

      // --- API CALLS ---
      async function callApi(endpoint, options = {}) {
        try {
          const response = await fetch(`${BASE_URL}${endpoint}`, options);
          if (!response.ok) {
            const error = await response
              .json()
              .catch(() => ({ message: response.statusText }));
            throw new Error(error.message || error.error || "Request failed");
          }
          return response.json();
        } catch (error) {
          console.error(`API call to ${endpoint} failed:`, error);
          alert(`Error: ${error.message}. Could not connect to the server.`);
          throw error;
        }
      }

      async function loadDashboardData() {
        if (!currentUserId) return;
        try {
          const data = await callApi(`/api/dashboard?user_id=${currentUserId}`);
          console.log("Data received from backend:", data); // DEBUG LINE
          updateChart(data.glucose_readings || []);
        } catch (error) {
          // If the call fails, we still want to show an empty chart
          updateChart([]);
        }
      }

      // --- PAGE NAVIGATION ---
      function hideAllPages() {
        Object.values(pageRefs).forEach((el) => (el.style.display = "none"));
        pageRefs.mainHeader.style.display = "none";
      }

      function showPage(pageId, isFullScreen = false) {
        hideAllPages();
        pageRefs[pageId].style.display = isFullScreen ? "flex" : "block";
        if (!isFullScreen) pageRefs.mainHeader.style.display = "flex";
      }

      function updateNav(isLoggedIn) {
        logOutButton.style.display = isLoggedIn ? "block" : "none";
        registerLink.style.display = isLoggedIn ? "none" : "block";
        logInLink.style.display = isLoggedIn ? "none" : "block";
      }

      function showMainPage() {
        showPage("mainPage");
        updateNav(false);
      }
      function showRegisterPage() {
        showPage("registerPage", true);
      }
      function showLogInPage() {
        showPage("logInPage", true);
      }

      async function showDashboardPage() {
        if (!currentUserId) {
          showLogInPage();
          return;
        }
        showPage("dashboardPage");
        updateNav(true);
        chatHistory.innerHTML = "";
        pushMessage("aura", "Welcome! How can I help?");
        await loadDashboardData();
      }

      // --- EVENT LISTENERS ---
      logo.addEventListener("click", (e) => {
        e.preventDefault();
        showMainPage();
      });
      registerLink.addEventListener("click", (e) => {
        e.preventDefault();
        showRegisterPage();
      });
      logInLink.addEventListener("click", (e) => {
        e.preventDefault();
        showLogInPage();
      });
      backToLoginLink.addEventListener("click", (e) => {
        e.preventDefault();
        showLogInPage();
      });
      getStartedBtn.addEventListener("click", (e) => {
        e.preventDefault();
        showRegisterPage();
      });
      logOutButton.addEventListener("click", (e) => {
        e.preventDefault();
        currentUserId = null;
        showMainPage();
      });
      backToHomeLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          showMainPage();
        });
      });

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userData = {
          username: document.getElementById("register-email").value,
          password: document.getElementById("register-password").value,
          name: document.getElementById("register-name").value,
          age: parseInt(document.getElementById("register-age").value) || null,
          gender: document.getElementById("register-gender").value || null,
          phone_number: document.getElementById("register-phone").value || null,
          weight_kg:
            parseFloat(document.getElementById("register-weight").value) ||
            null,
          height_cm:
            parseFloat(document.getElementById("register-height").value) ||
            null,
        };
        try {
          await callApi("/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData),
          });
          alert("Registration successful! Please log in.");
          showLogInPage();
        } catch (error) {}
      });

      logInForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const loginData = {
          username: document.getElementById("email-login").value,
          password: document.getElementById("password-login").value,
        };
        try {
          const data = await callApi("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(loginData),
          });
          currentUserId = data.user_id;
          await showDashboardPage();
        } catch (error) {}
      });

      sendBtn.addEventListener("click", async () => {
        console.log("Send button clicked!"); // <-- ADD THIS LINE
        const text = chatInput.value.trim();
        if (!text || !currentUserId) return;
        pushMessage("user", text);
        chatInput.value = "";
        showThinking(true);
        try {
          const aiResponse = await callApi("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, user_id: currentUserId }),
          });
          applyAiResponseToUI(aiResponse);
          // Now, update the chart with the new prediction from the chat response
          const historicalData = await callApi(
            `/api/dashboard?user_id=${currentUserId}`
          );
          updateChart(
    historicalData.glucose_readings || [],
    aiResponse.glucose_prediction.adjusted_prediction || [] 
);
        } catch (error) {
          pushMessage(
            "aura",
            "Sorry, I couldn't get a response. Please check the connection."
          );
        } finally {
          showThinking(false);
        }
      });
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendBtn.click();
      });

      devSimulateBtn.addEventListener("click", async () => {
        if (!currentUserId) return alert("Log in first.");
        try {
          await callApi("/api/dev/simulate-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: currentUserId }),
          });
          alert(
            "New demo data has been added! The dashboard will now refresh."
          );
          await loadDashboardData();
        } catch (error) {}
      });

      document.addEventListener("DOMContentLoaded", () => {
        initChart();
        showMainPage();
      });
    </script>
  </body>
</html>
